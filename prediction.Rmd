---
title: "prediction"
output: html_document
date: "2024-06-11"
---

## Set up the environment

```{r}
rm(list = ls())
```


```{r}
library(ETAS.inlabru)
library(tidyverse)
set.seed(123)
```

```{r}
num.cores <- 12
future::plan(future::multisession, workers = num.cores)
INLA::inla.setOption(num.threads = num.cores)
```


# Fit the model to the synthetic catalogue

## simulate data
```{r}
# set true ETAS parameters
true.param <- list(mu = 0.30106014, K = 0.13611399, alpha = 2.43945301, c = 0.07098607, p = 1.17838741)
df.true.param <- data.frame(
  x = unlist(true.param),
  param = names(true.param)
)
# set magnitude distribution parameter
beta.p <- 2.353157
# set cutoff magnitude
M0 <- 2.5
# set starting time of the synthetic catalogue
T1 <- 0
# set end time of the synthetic catalogue
T2 <- 500
```

```{r}
synth.cat.list <- generate_temporal_ETAS_synthetic(
  theta = true.param,
  beta.p = beta.p,
  M0 = M0,
  T1 = T1,
  T2 = T2
)
# combine the synthetic catalogues
synth.cat.df <- do.call(rbind, synth.cat.list)
# order the synthetic catalogue by time
synth.cat.df <- synth.cat.df[order(synth.cat.df$ts), ]
# create a column with the index of the event
synth.cat.df$idx.p <- seq_len(nrow(synth.cat.df))
# create a column with the generation of the event
synth.cat.df$dgen <- case_when(
  synth.cat.df$gen == 1 ~ "Background",
  synth.cat.df$gen > 1 ~ "Triggered",
  .default = "Other"
)
```

## Plot the synthetic catalogue

```{r}
ggplot(synth.cat.df, aes(ts, magnitudes, color = as.factor(gen))) +
  geom_point(size = 0.5)
```

```{r}
names(synth.cat.df)
# > names(synth.cat.df)
# [1] "ts"         "magnitudes" "gen"
# reordering colu 
```

## Set up the model

```{r}
link.f <- list(
  mu = \(x) gamma_t(x, 0.3, 0.6),
  K = \(x) unif_t(x, 0, 10),
  alpha = \(x) unif_t(x, 0, 10),
  c_ = \(x) unif_t(x, 0, 10),
  p = \(x) unif_t(x, 1, 10)
)

# set inverse copula transformations list
inv.link.f <- list(
  mu = \(x) inv_gamma_t(x, 0.3, 0.6),
  K = \(x) inv_unif_t(x, 0, 10),
  alpha = \(x) inv_unif_t(x, 0, 10),
  c_ = \(x) inv_unif_t(x, 0, 10),
  p = \(x) inv_unif_t(x, 1, 10)
)

# set up list of initial values
th.init <- list(
  th.mu = inv.link.f$mu(0.5),
  th.K = inv.link.f$K(0.1),
  th.alpha = inv.link.f$alpha(1),
  th.c = inv.link.f$c_(0.1),
  th.p = inv.link.f$p(1.1)
)

bru.opt.list <- list(
  bru_verbose = 0, # type of visual output
  bru_max_iter = 70, # maximum number of iterations
  #bru_method = list(max_step = 0.5),
  bru_initial = th.init
) # parameters initial values
```

## Fit the model
```{r}
T1.train <- 0
T2.train <- 450

# create a training dataset
synth.cat.df.train <- synth.cat.df[synth.cat.df$ts <= T2.train, ]

synth.fit <- Temporal.ETAS(
    total.data = synth.cat.df.train,
    M0 = M0,
    T1 = T1.train,
    T2 = T2.train,
    link.functions = link.f,
    coef.t. = 1,
    delta.t. = 0.1,
    N.max. = 5,
    bru.opt = bru.opt.list
)

input_list <- list(
  model.fit = synth.fit,
  link.functions = link.f
)
```

## Posterior sampling

```{r}
post.samp <- post_sampling(
  input.list = input_list,
  n.samp = 1000,
  max.batch = 1000
)
```

## Forecasting

```{r}

T1.fore <- 450 + 1 / (24 * 60)
T2.fore <- 500
Ht.fore <- synth.cat.df[synth.cat.df$ts <= T2.train, ]

# maximum likelihood estimator for beta
beta.p <- 1 / (mean(synth.cat.df$magnitudes) - M0)

fore.50days <- Temporal.ETAS.forecast(
  post.samp = post.samp, 
  n.cat = nrow(post.samp), 
  beta.p = beta.p, 
  M0 = M0, 
  T1 = T1.fore, 
  T2 = T2.fore, 
  Ht = Ht.fore, 
  ncore = num.cores
)
```

## Plot the forecast

```{r}
# find number of events per catalogue
N.fore <- vapply(
  seq_len(fore.50days$n.cat),
  \(x) sum(fore.50days$fore.df$cat.idx == x), 0
)
# find number of observed events in the forecasting period
N.obs <- sum(synth.cat.df$ts >= T1.fore & synth.cat.df$ts <= T2.fore)
print(N.obs)
# plot the distribution
ggplot() +
  geom_histogram(aes(x = N.fore, y = after_stat(density)), binwidth = 1) +
  geom_vline(xintercept = N.obs, color='red') +
  xlim(0, 100)
```

```{r}
N.obs
```


# Fit the model to the seeded catalogue

## Generate the seeded catalogue
```{r}

known.events.df <- data.frame(
  ts = c(450),
  magnitudes = c(6.7)
)

synth.cat.seeded.list <- generate_temporal_ETAS_synthetic(
  theta = true.param,
  beta.p = beta.p,
  M0 = M0,
  T1 = T1,
  T2 = T2,
  Ht = known.events.df
)

# combine the synthetic catalogues
synth.cat.seeded.df <- do.call(rbind, synth.cat.seeded.list)
# order the synthetic catalogue by time
synth.cat.seeded.df <- synth.cat.seeded.df[order(synth.cat.seeded.df$ts), ]
# create a column with the index of the event
synth.cat.seeded.df$idx.p <- seq_len(nrow(synth.cat.seeded.df))
# create a column with the generation of the event
synth.cat.seeded.df$dgen <- case_when(
  synth.cat.seeded.df$gen == 1 ~ "Background",
  synth.cat.seeded.df$gen > 1 ~ "Triggered",
  .default = "Other"
)
```

## Plot the seeded catalogue

```{r}
ggplot(synth.cat.seeded.df, aes(ts, magnitudes, color = as.factor(gen))) +
  geom_point(size = 0.5)
```

## Fit the model
```{r}
T1.train <- 0
T2.train <- 450

# create a training dataset
synth.cat.seeded.df.train <- synth.cat.seeded.df[synth.cat.seeded.df$ts <= T2.train, ]

synth.fit.seeded <- Temporal.ETAS(
  total.data = synth.cat.seeded.df.train,
  M0 = M0,
  T1 = T1.train,
  T2 = T2.train,
  link.functions = link.f,
  coef.t. = 1,
  delta.t. = 0.1,
  N.max. = 5,
  bru.opt = bru.opt.list
)

input_list_seeded <- list(
  model.fit = synth.fit.seeded,
  link.functions = link.f
)
```

## Posterior sampling

```{r}
post.samp.seeded <- post_sampling(
  input.list = input_list_seeded,
  n.samp = 1000,
  max.batch = 1000
)
```

## Forecasting

```{r}
beta.p <- 1 / (mean(synth.cat.seeded.df$magnitudes) - M0)

fore.50days.seeded <- Temporal.ETAS.forecast(
  post.samp = post.samp.seeded, 
  n.cat = nrow(post.samp.seeded), 
  beta.p = beta.p, 
  M0 = M0, 
  T1 = T1.fore, 
  T2 = T2.fore, 
  Ht = Ht.fore, 
  ncore = num.cores
)
```

## Plot the forecast

```{r}
# find number of events per catalogue
N.fore.seeded <- vapply(
  seq_len(fore.50days.seeded$n.cat),
  \(x) sum(fore.50days.seeded$fore.df$cat.idx == x), 0
)
# find number of observed events in the forecasting period
N.obs <- sum(synth.cat.seeded.df$ts >= T1.fore & synth.cat.seeded.df$ts <= T2.fore)
print(N.obs)
# plot the distribution
ggplot() +
  geom_histogram(aes(x = N.fore.seeded, y = after_stat(density)), binwidth = 1) +
  geom_vline(xintercept = N.obs, color='red') +
  xlim(0, 2000)

```

# use data from 0-951.00 to predict 951.01-1000

```{r}
T1.train <- 0
T2.train <- 451

# create a training dataset
synth.cat.df.train <- synth.cat.df[synth.cat.df$ts <= T2.train, ]

synth.further.fit <- Temporal.ETAS(
  total.data = synth.cat.df.train,
  M0 = M0,
  T1 = T1.train,
  T2 = T2.train,
  link.functions = link.f,
  coef.t. = 1,
  delta.t. = 0.1,
  N.max. = 5,
  bru.opt = bru.opt.list
)

input_list_further <- list(
  model.fit = synth.further.fit,
  link.functions = link.f
)

post.samp.further <- post_sampling(
  input.list = input_list_further,
  n.samp = 1000,
  max.batch = 1000
)

T1.fore <- 451 + 1 / (24 * 60)
T2.fore <- 500

fore.50days.further <- Temporal.ETAS.forecast(
  post.samp = post.samp.further, 
  n.cat = nrow(post.samp.further), 
  beta.p = beta.p, 
  M0 = M0, 
  T1 = T1.fore, 
  T2 = T2.fore, 
  Ht = Ht.fore, 
  ncore = num.cores
)

```

## Plot the forecast

```{r}
# find number of events per catalogue
N.fore.further <- vapply(
  seq_len(fore.50days.further$n.cat),
  \(x) sum(fore.50days.further$fore.df$cat.idx == x), 0
)

# find number of observed events in the forecasting period
N.obs <- sum(synth.cat.seeded.df$ts >= T1.fore & synth.cat.seeded.df$ts <= T2.fore)
print(N.obs)
# plot the distribution
ggplot() +
  geom_histogram(aes(x = N.fore.further, y = after_stat(density)), binwidth = 1) +
  geom_vline(xintercept = N.obs, color='red') +
  xlim(0, 1000)
```